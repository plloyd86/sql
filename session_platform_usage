
--This ranks all the different combined_id sessions by date and with their platform and device type aganist it
WITH SESSION_PLATFORM_USAGE AS (

SELECT
      COMBINED_ID
    , PLATFORM_DEVICE
    , CAMPAIGN_MEDIUM
    , SESSION_START_TIMESTAMP
    , COUNT(COMBINED_ID) AS SESSION_COUNT
    , RANK() OVER(PARTITION BY COMBINED_ID ORDER BY SESSION_START_TIMESTAMP ASC) AS SESSION_RANK

FROM PRODUCTION.DENORMALISED.PLATFORM_SESSION_TABLE

GROUP BY
     1
    ,2
    ,3
    ,4
)

--This does the same as above but ranks the sessions that include an order
, SESSION_PLATFORM_ORDER_USAGE AS (
SELECT
      COMBINED_ID
    , PLATFORM_DEVICE
    , CAMPAIGN_MEDIUM
    , SESSION_START_TIMESTAMP
    , COUNT(COMBINED_ID) AS ORDER_SESSION_COUNT
    , RANK() OVER(PARTITION BY COMBINED_ID ORDER BY SESSION_START_TIMESTAMP ASC) AS ORDER_RANK
FROM PRODUCTION.DENORMALISED.PLATFORM_SESSION_TABLE

WHERE
  UNIQUE_COMPLETED_ORDER_EVENTS > 0

GROUP BY
     1
    ,2
    ,3
    ,4
)

-- This combines the session and the session order data together
, PLATFORM_USAGE AS(

    SELECT

    A.COMBINED_ID
    ,A.PLATFORM_DEVICE
    ,A.CAMPAIGN_MEDIUM
    ,A.SESSION_START_TIMESTAMP
    ,A.SESSION_COUNT
    ,A.SESSION_RANK
    ,B.ORDER_SESSION_COUNT
    ,B.ORDER_RANK

    

FROM SESSION_PLATFORM_USAGE A

LEFT JOIN SESSION_PLATFORM_ORDER_USAGE B
    ON A.COMBINED_ID = B.COMBINED_ID
    AND A.SESSION_START_TIMESTAMP = B.SESSION_START_TIMESTAMP
  )


SELECT
    COMBINED_ID
--    ,SESSION_START_TIMESTAMP::DATE AS DATE
    ,COUNT(SESSION_COUNT) AS TOTAL_SESSIONS
    ,COUNT(ORDER_SESSION_COUNT) AS TOTAL_ORDERS 
    ,COUNT(DISTINCT SESSION_START_TIMESTAMP::DATE) AS VISITS
    ,COUNT(DISTINCT PLATFORM_DEVICE) AS DISTINCT_PLATFORM
    ,COUNT(DISTINCT CAMPAIGN_MEDIUM) AS DISTINCT_MARKETING_CHANNEL
    ,MIN(PLATFORM_DEVICE) AS FIRST_PLATFORM
    ,MAX(PLATFORM_DEVICE) AS LAST_PLATFORM
    ,MIN(CAMPAIGN_MEDIUM) AS FIRST_MARKETING_MEDIUM
    ,MAX(CAMPAIGN_MEDIUM) AS LAST_MARKETING_MEDIUM    
    ,MAX(CASE WHEN ORDER_RANK = 1 THEN PLATFORM_DEVICE ELSE NULL END) AS FIRST_ORDER_PLATFORM
    ,MIN(CASE WHEN ORDER_RANK > 1 THEN PLATFORM_DEVICE ELSE NULL END) AS LAST_ORDER_PLATFORM
    
FROM PLATFORM_USAGE

GROUP BY
     1;
--    ,2



    



